import { LogLevel } from "@sapphire/framework";
import { type InternationalizationContext } from "@sapphire/plugin-i18next";
import {
	GatewayIntentBits,
	type ClientOptions,
	ActivityType,
	PresenceUpdateStatus,
} from "discord.js";
import { join } from "path";
import { getOrCreateGuild } from "../database/guilds";
import {
	BreakParser,
	DefineParser,
	FiftyFiftyParser,
	IfStatementParser,
	IncludesParser,
	JSONVarParser,
	LooseVarsParser,
	OrdinalFormatParser,
	RandomParser,
	RangeParser,
	ReplaceParser,
	SliceParser,
	StrictVarsParser,
} from "tagscript";
import { type NodeOption } from "shoukaku";
import { OCRParser } from "./parsers/ocr";
import { FetchParser } from "./parsers/fetch";
import {
	EmbedParser,
	FilesParser,
	DeleteParser,
} from "tagscript-plugin-discord";

export const rootDir = join(__dirname, "..", "..");
export const srcDir = join(rootDir, "src");

export const nodes: NodeOption[] /** Lavalink nodes */ = [
	{
		name: "Europe",
		url: "eu-lavalink.lexnet.cc",
		auth: "lexn3tl@val!nk",
		secure: true,
	},
	{
		name: "North America",
		url: "lavalink.lexnet.cc",
		auth: "lexn3tl@val!nk",
		secure: true,
	},
	{
		name: "Australia",
		url: "oce-lavalink.lexnet.cc",
		auth: "lexn3tl@val!nk",
		secure: true,
	},
];

export const accentColor = "#56c4fb";

export const tagParsers = [
	new BreakParser(),
	new DefineParser(),
	new FiftyFiftyParser(),
	new IfStatementParser(),
	new IncludesParser(),
	new JSONVarParser(),
	new LooseVarsParser(),
	new OrdinalFormatParser(),
	new RandomParser(),
	new RangeParser(),
	new ReplaceParser(),
	new SliceParser(),
	new StrictVarsParser(),

	// Discord parsers
	new EmbedParser(),
	new FilesParser(),
	new DeleteParser(),

	// Custom parsers
	new OCRParser(),
	new FetchParser(),
];

export const languages = [
	{
		name: "English",
		value: "en-US",
	},
	{
		name: "Spanish",
		value: "es-ES",
	},
];

export const CLIENT_OPTIONS: ClientOptions = {
	defaultPrefix: "!",
	caseInsensitiveCommands: true,
	logger: {
		level: LogLevel.Debug,
	},
	intents: [
		GatewayIntentBits.GuildMessages,
		GatewayIntentBits.Guilds,
		GatewayIntentBits.MessageContent,
		GatewayIntentBits.GuildVoiceStates,
	],
	loadMessageCommandListeners: false,
	loadDefaultErrorListeners: true,
	loadSubcommandErrorListeners: true,
	presence: {
		activities: [
			{
				name: "for tags 🏷",
				type: ActivityType.Watching,
			},
		],
		status: PresenceUpdateStatus.Online,
		afk: false,
	},
	subcommandsAdvanced: {
		nameCommandsAutogenerated: true,
	},
	i18n: {
		fetchLanguage: async (context: InternationalizationContext) => {
			if (!context.guild) return "en-US";

			const guild = await getOrCreateGuild(context.guild.id);

			if (!guild) return "en-US";

			return guild.language;
		},
		i18next: {
			fallbackLng: "en-US",
			interpolation: {
				defaultVariables: {
					error: "❎",
					ok: "✅",
					info: ":information_source:",
				},
			},
		},
	},
};
